version: '3.7'

services:
  rproxy:
    build:
      context: ../../
      dockerfile: docker/rproxy/Dockerfile
    image: wbhonline/rproxy:${VERSION}
    restart: "no"
    environment:
      - TZ=Europe/Berlin
    volumes:
      - rproxy_etc_nginx:/etc/nginx:rw
      - rproxy_certs:/etc/letsencrypt:ro
      - joomla_html:/var/www/html:ro
    networks:
      cms-backend:
        ipv4_address: "${CMS_BACKEND_NET}.${RPROXY_IP}"
      bookworm-backend:
        ipv4_address: "${HOERBUCHKATALOG_BACKEND_NET}.${RPROXY_IP}"
#      bookworm-secure:
#        ipv4_address: "${HOERBUCHKATALOG_SECURE_NET}.${RPROXY_IP}"
      bookworm-public:
    ports:
      - "${RPROXY_PUBLIC_HTTP_PORT}:80"
      - "${RPROXY_PUBLIC_HTTPS_PORT}:443"
    logging:
      driver: "json-file"
      options:
        max-size: "64m"
        max-file: "7"
  rproxy-certbot:
    build:
      context: ../../
      dockerfile: docker/rproxy-certbot/Dockerfile
    image: wbhonline/rproxy-certbot:${VERSION}
    restart: "no"
    depends_on:
      - rproxy
    environment:
      - TZ=Europe/Berlin
    volumes:
      - rproxy_etc_nginx:/etc/nginx:rw
      - rproxy_certs:/etc/letsencrypt:rw
    logging:
      driver: "json-file"
      options:
        max-size: "64m"
        max-file: "7"

volumes:
  rproxy_etc_nginx:
    driver: local
  rproxy_certs:
    driver: local

networks:
  bookworm-public:
    name: bookworm-public
    driver: bridge
    external: false
    internal: false
