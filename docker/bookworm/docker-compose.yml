version: '3.7'

services:
  vault:
    build:
      context: ../bookworm-vault
      dockerfile: Dockerfile
    image: bookworm/vault:LocalBuild
    networks:
      bookworm-secure:
        ipv4_address: "172.16.1.3"
    expose:
      - 8200
    volumes:
      - vault:/opt/vault:rw
#    environment:
#      - VAULT_ADDR=http://172.16.1.3:8200
    command: server -config=/opt/vault/config/vault-config.json
    cap_add:
      - IPC_LOCK
  hoerbuchkatalog:
    build:
      context: ../../
      dockerfile: docker/bookworm-hoerbuchkatalog/Dockerfile
    image: bookworm/hoerbuchkatalog:LocalBuild
    restart: "no"
    depends_on:
      - vault
    environment:
      - HOERBUCHKATALOG_TEMPLATE=/opt/bookworm/var/templates
    volumes:
      - app:/opt/bookworm:ro
      - templates:/opt/bookworm/var/templates:ro
      - wbh:/opt/bookworm/var/wbh:rw
      - blista:/opt/bookworm/var/blista:rw
      - repository:/opt/bookworm/var/repository:rw
    networks:
      bookworm-outside:
      bookworm-backend:
        ipv4_address: "172.16.48.4"
      bookworm-secure:
        ipv4_address: "172.16.1.4"
    expose:
      - 9080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://172.16.48.4:9080"]
      interval: 5m0s
      timeout: 1s
      retries: 3
      start_period: 60s
  admin:
    build:
      context: ../../
      dockerfile: docker/bookworm-admin/Dockerfile
    image: bookworm/admin:LocalBuild
    depends_on:
      - hoerbuchkatalog
    restart: "no"
    ports:
      - "2202:22"
    volumes:
      - admin_etc_ssh:/etc/ssh:ro
      - app:/opt/bookworm:rw
      - templates:/opt/bookworm/var/templates:rw
      - wbh:/opt/bookworm/var/wbh:rw
      - blista:/opt/bookworm/var/blista:ro
      - repository:/opt/bookworm/var/repository:rw
    networks:
      - bookworm-public
  datatransfer:
    build:
      context: ../../
      dockerfile: docker/bookworm-datatransfer/Dockerfile
    image: bookworm/datatransfer:LocalBuild
    depends_on:
      - hoerbuchkatalog
    restart: "no"
    ports:
      - "2201:22"
    volumes:
      - datatransfer_etc_ssh:/etc/ssh:rw
      - wbh:/opt/bookworm/var/wbh:rw
    networks:
      - bookworm-public
  rproxy:
    build:
      context: ../../
      dockerfile: docker/bookworm-rproxy/Dockerfile
    image: bookworm/rproxy:LocalBuild
    depends_on:
      - hoerbuchkatalog
    restart: "no"
    volumes:
      - rproxy_etc_nginx:/etc/nginx:ro
      - rproxy_certs:/etc/nginx/certs:ro
    networks:
      bookworm-backend:
        ipv4_address: "172.16.48.2"
      bookworm-secure:
        ipv4_address: "172.16.1.2"
      bookworm-public:
    ports:
      - "80:80"
      - "443:443"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 5m0s
      timeout: 1s
      retries: 3
      start_period: 60s

networks:
  bookworm-backend:
    name: bookworm-backend
    driver: bridge
    external: false
    internal: true
    ipam:
      driver: default
      config:
        - subnet: "172.16.48.0/24"
  bookworm-secure:
    name: bookworm-secure
    driver: bridge
    external: false
    internal: true
    ipam:
      driver: default
      config:
        - subnet: "172.16.1.0/24"
  bookworm-outside:
    name: bookworm-outside
    driver: bridge
    external: false
    internal: false
  bookworm-public:
    name: bookworm-public
    driver: bridge
    external: false
    internal: false

volumes:
  admin_etc_ssh:
    driver: local
  datatransfer_etc_ssh:
    driver: local
  vault:
    driver: local
  app:
    driver: local
  templates:
    driver: local
  wbh:
    driver: local
  blista:
    driver: local
  repository:
    driver: local
  rproxy_etc_nginx:
    driver: local
  rproxy_certs:
    driver: local
