version: '3.7'

services:
  wbh-online-db:
    image: mysql:5.6
    restart: "no"
    environment:
      MYSQL_ROOT_PASSWORD: example
#      - MYSQL_ALLOW_EMPTY_PASSWORD=yes
#      - MYSQL_ROOT_PASSWORD=
#      - MYSQL_DATABASE=cache
    networks:
      - cms-backend
    expose:
      - "3306"
    healthcheck:
      test: ["CMD", "mysql" ,"-h", "localhost", "-P", "3306", "-u", "root", "-e", "SELECT 1", "cache"]
      interval: 1s
      timeout: 3s
      retries: 10
  wbh-online-cms:
    image: joomla:3.9.3-fpm-alpine
    depends_on:
      wbh-online-db:
        condition: service_healthy
    restart: "no"
    environment:
      JOOMLA_DB_HOST: wbh-online-db
#DB NAME
#USER
      JOOMLA_DB_PASSWORD: example
    networks:
      - cms-backend
    expose:
      - "80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 5m0s
      timeout: 1s
      retries: 3
      start_period: 60s
  bookworm-vault:
    build:
      context: ../bookworm-vault
      dockerfile: Dockerfile
    ports:
      - "8200:8200"
    networks:
      - bookworm-backend
    volumes:
      - ./vault/config:/vault/config
      - ./vault/policies:/vault/policies
      - ./vault/data:/vault/data
      - ./vault/logs:/vault/logs
    environment:
      - VAULT_ADDR=http://127.0.0.1:8200
    command: server -config=/vault/config/vault-config.json
    cap_add:
      - IPC_LOCK
  bookworm-hoerbuchkatalog:
    build:
      context: ../../
      dockerfile: docker/bookworm-hoerbuchkatalog/Dockerfile
    image: bookworm/hoerbuchkatalog:LocalBuild
    restart: "no"
    depends_on:
      bookworm-vault:
        condition: service_healthy
    environment:
      - HOERBUCHKATALOG_TEMPLATE=/opt/bookworm/var/templates
    volumes:
      - bookworm_app:/opt/bookworm/app
      - bookworm_templates:/opt/bookworm/var/templates
      - bookworm_wbh:/opt/bookworm/var/wbh
      - bookworm_blista:/opt/bookworm/var/blista
      - bookworm_repository:/opt/bookworm/var/repository
    networks:
      bookworm-outside:
      bookworm-backend:
        ipv4_address: "192.168.48.3"
    expose:
      - "9080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 5m0s
      timeout: 1s
      retries: 3
      start_period: 60s
  bookworm-datatransfer:
    build:
      context: ../../
      dockerfile: docker/bookworm-datatransfer/Dockerfile
    image: bookworm/datatransfer:LocalBuild
    depends_on:
      bookworm-hoerbuchkatalog:
        condition: service_healthy
    restart: "no"
    ports:
      - "2201:22"
    volumes:
      - datatransfer_etc_ssh:/etc/ssh
      - bookworm_templates:/opt/bookworm/var/templates
      - bookworm_wbh:/opt/bookworm/var/wbh
    networks:
      - bookworm-public
  bookworm-admin:
    build:
      context: ../../
      dockerfile: docker/bookworm-admin/Dockerfile
    image: bookworm/admin:LocalBuild
    depends_on:
      bookworm-hoerbuchkatalog:
        condition: service_started
    restart: "no"
    ports:
      - "2202:22"
    volumes:
      - admin_etc_ssh:/etc/ssh
      - bookworm_app:/opt/bookworm/app
      - bookworm_templates:/opt/bookworm/var/templates
      - bookworm_wbh:/opt/bookworm/var/wbh
      - bookworm_blista:/opt/bookworm/var/blista
      - bookworm_repository:/opt/bookworm/var/repository
    networks:
      - bookworm-public
  bookworm-rproxy:
    build:
      context: ../../
      dockerfile: docker/bookworm-rproxy/Dockerfile
    image: bookworm/rproxy:LocalBuild
    depends_on:
      wbh-online-cms:
        condition: service_healthy
      bookworm-hoerbuchkatalog:
        condition: service_healthy
    restart: "no"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - rproxy_etc_nginx:/etc/nginx
    networks:
      cms-backend:
      bookworm-backend:
        ipv4_address: "192.168.48.2"
      bookworm-public:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 5m0s
      timeout: 1s
      retries: 3
      start_period: 60s

networks:
  cms-backend:
    name: cms-backend
    driver: bridge
    external: false
    internal: true
    ipam:
      driver: default
      config:
        - subnet: "192.168.47.0/24"
  bookworm-backend:
    name: bookworm-backend
    driver: bridge
    external: false
    internal: true
    ipam:
      driver: default
      config:
        - subnet: "192.168.48.0/24"
  bookworm-outside:
    name: bookworm-outside
    driver: bridge
    external: false
    internal: false
  bookworm-public:
    name: bookworm-public
    driver: bridge
    external: false
    internal: false

volumes:
  admin_etc_ssh:
    driver: local
  datatransfer_etc_ssh:
    driver: local
  bookworm_app:
    driver: local
  bookworm_templates:
    driver: local
  bookworm_wbh:
    driver: local
  bookworm_blista:
    driver: local
  bookworm_repository:
    driver: local
  rproxy_etc_nginx:
    driver: local
