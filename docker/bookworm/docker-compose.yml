version: '3.7'

services:
#  bookworm-vault:
#    build:
#      context: ../bookworm-vault
#      dockerfile: Dockerfile
#    networks:
#      - bookworm-backend
#    ports:
#      - 8200:8200
#    volumes:
#      - bookworm_vault:/vault
#    environment:
#      - VAULT_ADDR=http://127.0.0.1:8200
#    command: server -config=/vault/config/vault-config.json
#    cap_add:
#      - IPC_LOCK
  bookworm-hoerbuchkatalog:
    build:
      context: ../../
      dockerfile: docker/bookworm-hoerbuchkatalog/Dockerfile
    image: bookworm/hoerbuchkatalog:LocalBuild
    restart: "no"
#    depends_on:
#      - bookworm-vault
    environment:
      - HOERBUCHKATALOG_TEMPLATE=/opt/bookworm/var/templates
    volumes:
      - bookworm_app:/opt/bookworm/app
      - bookworm_templates:/opt/bookworm/var/templates
      - bookworm_wbh:/opt/bookworm/var/wbh
      - bookworm_blista:/opt/bookworm/var/blista
      - bookworm_repository:/opt/bookworm/var/repository
    networks:
      bookworm-outside:
      bookworm-backend:
        ipv4_address: "192.168.48.3"
    expose:
      - 9080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 5m0s
      timeout: 1s
      retries: 3
      start_period: 60s
  bookworm-datatransfer:
    build:
      context: ../../
      dockerfile: docker/bookworm-datatransfer/Dockerfile
    image: bookworm/datatransfer:LocalBuild
    depends_on:
      - bookworm-hoerbuchkatalog
    restart: "no"
    ports:
      - "2201:22"
    volumes:
      - datatransfer_etc_ssh:/etc/ssh
      - bookworm_wbh:/opt/bookworm/var/wbh
    networks:
      - bookworm-public
  bookworm-admin:
    build:
      context: ../../
      dockerfile: docker/bookworm-admin/Dockerfile
    image: bookworm/admin:LocalBuild
    depends_on:
      - bookworm-hoerbuchkatalog
    restart: "no"
    ports:
      - "2202:22"
    volumes:
      - admin_etc_ssh:/etc/ssh
      - bookworm_app:/opt/bookworm/app
      - bookworm_templates:/opt/bookworm/var/templates
      - bookworm_wbh:/opt/bookworm/var/wbh
      - bookworm_blista:/opt/bookworm/var/blista
      - bookworm_repository:/opt/bookworm/var/repository
    networks:
      - bookworm-public
  bookworm-rproxy:
    build:
      context: ../../
      dockerfile: docker/bookworm-rproxy/Dockerfile
    image: bookworm/rproxy:LocalBuild
    depends_on:
      - bookworm-hoerbuchkatalog
    restart: "no"
    volumes:
      - rproxy_etc_nginx:/etc/nginx
    networks:
      bookworm-backend:
        ipv4_address: "192.168.48.2"
      bookworm-public:
    ports:
      - "80:80"
      - "443:443"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 5m0s
      timeout: 1s
      retries: 3
      start_period: 60s

networks:
  bookworm-backend:
    name: bookworm-backend
    driver: bridge
    external: false
    internal: true
    ipam:
      driver: default
      config:
        - subnet: "192.168.48.0/24"
  bookworm-outside:
    name: bookworm-outside
    driver: bridge
    external: false
    internal: false
  bookworm-public:
    name: bookworm-public
    driver: bridge
    external: false
    internal: false

volumes:
  admin_etc_ssh:
    driver: local
  datatransfer_etc_ssh:
    driver: local
  bookworm_vault:
    driver: local
  bookworm_app:
    driver: local
  bookworm_templates:
    driver: local
  bookworm_wbh:
    driver: local
  bookworm_blista:
    driver: local
  bookworm_repository:
    driver: local
  rproxy_etc_nginx:
    driver: local
